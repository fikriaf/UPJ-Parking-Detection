flowchart TD
    Start([Start Server]) --> Init[Init FastAPI]
    Init --> LoadModel[Load YOLO]
    LoadModel --> LoadCalib[Load Calibration]
    LoadCalib --> Ready[Ready]
    
    Ready --> API{API Request}
    
    %% Upload Frame Flow
    API -->|POST /upload| UploadFrame[Receive Frame]
    UploadFrame --> ValidateFrame{Valid?}
    ValidateFrame -->|No| Error400[400 Error]
    ValidateFrame -->|Yes| SaveFrame[Save Frame]
    SaveFrame --> CreateSession{Session Exists?}
    CreateSession -->|No| NewSession[New Session]
    CreateSession -->|Yes| UpdateSession[Update Session]
    NewSession --> StoreFrame[Store Metadata]
    UpdateSession --> StoreFrame
    StoreFrame --> Return200[200 OK]
    
    %% Complete Session Flow
    API -->|POST /complete| CompleteReq[Complete Request]
    CompleteReq --> GetFrames[Get Frames]
    GetFrames --> ProcessLoop{Each Frame}
    ProcessLoop --> RunYOLO[Run YOLO]
    RunYOLO --> GetDetections[Get Boxes]
    GetDetections --> CheckCalib{Calib Active?}
    CheckCalib -->|Yes| AssignRows[Assign Rows]
    CheckCalib -->|No| StoreDetection[Store Results]
    AssignRows --> CalcSpaces[Calc Spaces]
    CalcSpaces --> StoreDetection
    StoreDetection --> NextFrame{More?}
    NextFrame -->|Yes| ProcessLoop
    NextFrame -->|No| SelectBest[Select Best]
    SelectBest --> DrawAnnotations[Draw Annotations]
    DrawAnnotations --> SaveImage[Save Image]
    SaveImage --> UpdateStatus[Update Status]
    UpdateStatus --> ReturnResult[Return Result]
    
    %% Get Results Flow
    API -->|GET /results/live| GetLive[Get Live]
    GetLive --> ReturnLive[Return Live]
    
    API -->|GET /results/:id| GetSession[Get Session]
    GetSession --> ReturnSession[Return Session]
    
    API -->|GET /results/:id/image| GetImage[Get Image]
    GetImage --> ReturnImage[Return JPEG]
    
    API -->|GET /results/latest| GetLatest[Get Latest]
    GetLatest --> ReturnList[Return List]
    
    %% Calibration Flow
    API -->|POST /calibration| CalibReq[Calib Request]
    CalibReq --> ValidateCalib{Valid?}
    ValidateCalib -->|No| Error422[422 Error]
    ValidateCalib -->|Yes| SaveCalib[Save Calib]
    SaveCalib --> ReturnCalib[Return Calib]
    
    API -->|GET /calibration/:id| GetCalibReq[Get Calib]
    GetCalibReq --> ReturnCalibData[Return Data]
    
    API -->|DELETE /calibration/:id| DeleteCalib[Delete Calib]
    DeleteCalib --> ReturnDelete[Success]
    
    %% Error Handling
    Error400 --> API
    Error422 --> API
    Return200 --> API
    ReturnResult --> API
    ReturnLive --> API
    ReturnSession --> API
    ReturnImage --> API
    ReturnList --> API
    ReturnCalib --> API
    ReturnCalibData --> API
    ReturnDelete --> API
    
    style Start fill:#90EE90
    style Ready fill:#87CEEB
    style Error400 fill:#FFB6C1
    style Error422 fill:#FFB6C1
    style ReturnResult fill:#98FB98
    style SaveImage fill:#FFD700
